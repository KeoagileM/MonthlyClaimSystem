@model List<ClaimSystem.Models.Claim>
@{
    ViewData["Title"] = "Manager Dashboard";
    var totalAccepted = ViewBag.TotalAccepted ?? 0M;
    var pendingCount = ViewBag.PendingCount ?? 0;
    var approvedCount = ViewBag.ApprovedCount ?? 0;
}

<!--The header for the manager-->
<div class="dashboard-header">
    <h1>Manager Dashboard</h1>
    <p>Welcome, @Context.Session.GetString("Username")!</p>
</div>

<!--The class of the stats-->
<div class="stats-container">
    <!--The total accepted value of the claims-->
    <div class="stat-card highlight">
        <div class="stat-icon"></div>
        <div class="stat-info">
            <h3>$@totalAccepted.ToString("F2")</h3>
            <p>Total Accepted Value</p>
        </div>
    </div>
    <!--The class for the pending reviews-->
    <div class="stat-card">
        <div class="stat-icon"></div>
        <div class="stat-info">
            <h3>@pendingCount</h3>
            <p>Pending Review</p>
        </div>
    </div>
    <!--The number of claims approved-->
    <div class="stat-card">
        <div class="stat-icon"></div>
        <div class="stat-info">
            <h3>@approvedCount</h3>
            <p>Coordinator Approved</p>
        </div>
    </div>
</div>

<!--The class that contains the claims that are approved by the coordinator-->
<div class="card">
    <h3>Claims Awaiting Final Decision</h3>

    <!--The manager will only be able to approve only when coordinator is approved-->
    @if (Model.Any(c => c.Status == "Coordinator Approved"))
    {
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Employee No.</th>
                        <th>Lecturer Name</th>
                        <th>Module</th>
                        <th>Date</th>
                        <th>Total Amount</th>
                        <th>Document</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var claim in Model.Where(c => c.Status == "Coordinator Approved").OrderBy(c => c.DateSubmitted))
                    {
                        <tr>
                            <td>@claim.Id</td>
                            <td>@claim.EmployeeNumber</td>
                            <td>@claim.LecturerName</td>
                            <td>@claim.Module</td>
                            <td>@claim.DateSubmitted.ToString("MMM dd, yyyy")</td>
                            <td><strong>$@claim.TotalAmount.ToString("F2")</strong></td>
                            <td>
                                @if (!string.IsNullOrEmpty(claim.DocumentPath))
                                {
                                    <a href="@claim.DocumentPath" target="_blank" class="btn-sm">View Document</a>
                                }
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <form asp-action="Accept" asp-controller="Manager" method="post" class="inline-form">
                                        <input type="hidden" name="id" value="@claim.Id" />
                                        <button type="submit" class="btn-success btn-sm">💰 Accept</button>
                                    </form>
                                    <form asp-action="Reject" asp-controller="Manager" method="post" class="inline-form">
                                        <input type="hidden" name="id" value="@claim.Id" />
                                        <div class="reject-form">
                                            <textarea name="rejectionReason" placeholder="Reason for rejection..."
                                              rows="2" class="reason-textarea"></textarea>
                                            <button type="submit" class="btn-danger btn-sm">❌ Reject</button>
                                        </div>
                                    </form>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
    else
    {
        <!--This happens when there ae no claims-->
        <div class="empty-state">
            <div class="empty-icon"></div>
            <h4>No Claims Awaiting Decision</h4>
            <p>All coordinator-reviewed claims have been processed.</p>
        </div>
    }
</div>

<!--All the claims that are rejected or accepted-->
<div class="card">
    <h3>All Claims Overview</h3>
    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Employee No.</th>
                    <th>Lecturer</th>
                    <th>Module</th>
                    <th>Date</th>
                    <th>Total Amount</th>
                    <th>Status</th>
                    <th>Final Feedback</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var claim in Model.OrderByDescending(c => c.DateSubmitted))
                {
                    <tr>
                        <td>@claim.Id</td>
                        <td>@claim.EmployeeNumber</td>
                        <td>@claim.LecturerName</td>
                        <td>@claim.Module</td>
                        <td>@claim.DateSubmitted.ToString("MMM dd, yyyy")</td>
                        <td>$@claim.TotalAmount.ToString("F2")</td>
                        <td>
                            @{
                                var statusClass = "status-" + claim.Status.ToLower().Replace(" ", "-");
                            }
                            <span class="status-badge @statusClass">
                                @claim.Status
                            </span>
                        </td>
                        <td>
                            @if (!string.IsNullOrEmpty(claim.RejectionReason))
                            {
                                <div class="feedback-full">
                                    @claim.RejectionReason
                                </div>
                            }
                            else if (claim.Status == "Accepted")
                            {
                                <span class="text-success">✓ Payment Approved</span>
                            }
                            else
                            {
                                <span class="text-muted">—</span>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>